<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Gebrauchtteile Bestands- und Einnahmeverwaltung</title>
    <style>
        /* --- Allgemeine Formatierung --- */
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input:not([type="date"]):not([type="file"]), select, button, .groupset-tag { margin-top: 5px; }
        input[type="number"], input[type="text"], input[type="date"], select { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Spezielle Anpassung f√ºr Export-Filter-Dropdowns */
        #exportStatusFilter, #exportKategorieFilter { width: auto; padding: 10px; border: 1px solid #ccc; border-radius: 4px; display: inline-block; margin-right: 10px; }


        /* --- Button-Styling --- */
        button { padding: 8px 12px; margin-top: 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;}
        button:hover { opacity: 0.9; }
        .btn-delete { background-color: #dc3545; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-csv, .btn-import { background-color: #28a745; }
        .btn-filter-export { background-color: #4CAF50; } /* Dunkleres Gr√ºn f√ºr den Status-Filter-Export */
        .btn-small { padding: 4px 8px; margin-top: 0; }
        .btn-bestands { background-color: #17a2b8; }
        .btn-buchhaltung { background-color: #ff8c00; } /* E√úR Orange */
        .btn-kategorie { background-color: #3f51b5; } /* Kategorien-Export Blau */

        /* --- Tabellen-Styling --- */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f0f0f0; }
        th:hover { background-color: #e0e0e0; cursor: pointer; } /* Mauszeiger und Farbe bei Hover */
        .gewinn-positiv { color: green; font-weight: bold; }
        .gewinn-negativ { color: red; font-weight: bold; }
        .lagerwert { color: #17a2b8; font-weight: bold; }
        .status-im_bestand { background-color: #f0f8ff; color: #0056b3; } /* Hellblau f√ºr Bestand */
        .status-reserviert { background-color: #fff3cd; color: #856404; }
        .status-verkauft { background-color: #cce5ff; color: #004085; }
        .status-bezahlt { background-color: #d4edda; color: #155724; font-weight: bold; }

        /* --- Gruppen Tags --- */
        .groupset-list { margin-top: 10px; margin-bottom: 20px;}
        .groupset-category { margin-top: 15px; font-weight: bold; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .groupset-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .groupset-tag { background-color: #e9ecef; color: #495057; padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .groupset-tag:hover { background-color: #ced4da; }
    </style>
</head>
<body>

<div class="container">
    <h1>üö≤ Gebrauchtteile Bestands- & Einnahmeverwaltung</h1>
    
    <div id="eingabe-formular">
        <h2>Neue Transaktion erfassen</h2>

        <div class="groupset-list">
            <div class="groupset-category">Schnellwahl: Groupsets</div>
            <div class="groupset-tags">
                <span class="groupset-tag" onclick="setGroupset('Shimano XTR')">XTR</span>
                <span class="groupset-tag" onclick="setGroupset('Shimano XT')">XT</span>
                <span class="groupset-tag" onclick="setGroupset('Shimano LX')">LX</span>
                <span class="groupset-tag" onclick="setGroupset('Shimano Dura Ace')">Dura Ace</span>
                <span class="groupset-tag" onclick="setGroupset('Shimano Ultegra')">Ultegra</span>
                <span class="groupset-tag" onclick="setGroupset('Shimano 105')">105</span>
                <span class="groupset-tag" onclick="setGroupset('Shimano Tiagra')">Tiagra</span>
            </div>
        </div>
        <form id="einnahmeForm">
            <input type="hidden" id="editIndex" value="-1">
            <input type="hidden" id="transaktionsID" value="-1"> 

            <label for="typ">Transaktionstyp:</label>
            <select id="typ" required onchange="zeigeStatusFeld()">
                <option value="einkauf">Einkauf (Bestand)</option>
                <option value="verkauf">Verkauf</option>
            </select>
            
            <label for="kategorie">Kategorie (Dropdown):</label>
            <select id="kategorie" required>
                <option value="Sonstiges">Sonstiges</option>
                <option value="Komplettrad">Komplettrad</option>
                <option value="Rahmen">Rahmen</option>
                <option value="Umwerfer">Umwerfer</option>
                <option value="Schaltwerk">Schaltwerk</option>
                <option value="Bremsen">Bremsen</option>
                <option value="Kurbelgarnitur">Kurbelgarnitur</option>
                <option value="Laufradsatz">Laufradsatz</option>
                <option value="Sattel/Sattelst√ºtze">Sattel/Sattelst√ºtze</option>
                <option value="Lenker/Vorbau">Lenker/Vorbau</option>
                <option value="Gruppenset">Gruppenset (Komplett)</option>
            </select>

            <label for="datum">Datum:</label>
            <input type="date" id="datum" value="" required>

            <label for="artikelName">Artikelname:</label>
            <input type="text" id="artikelName" required>
            
            <label for="warenwertBeiUebernahme">Warenwert bei √úbernahme in Bestand (‚Ç¨):</label>
            <input type="number" id="warenwertBeiUebernahme" step="0.01" value="0.00" required>

            <label for="einnahme_verkaufspreis">Einnahme/Verkaufspreis (‚Ç¨):</label>
            <input type="number" id="einnahme_verkaufspreis" step="0.01" value="0.00" required>

            <label for="kosten">Sonstige Kosten (Porto, Inserat, o.√§.):</label>
            <input type="number" id="kosten" step="0.01" value="0.00">

            <div id="status-container" style="display: none;">
                <label for="verkaufStatus">Verkaufsstatus:</label>
                <select id="verkaufStatus">
                    <option value="im_bestand">Im Bestand</option>
                    <option value="reserviert">Reserviert</option>
                    <option value="verkauft">Verkauft</option>
                    <option value="bezahlt">Bezahlt</option>
                </select>
            </div>
            <button type="submit" id="submitButton">Transaktion speichern</button>
            <button type="button" id="cancelButton" style="display:none;" onclick="abbrechenBearbeitung()">Abbrechen</button>
        </form>
    </div>
    
    <hr>

    <div id="uebersicht">
        <h2>√úbersicht der Transaktionen</h2>
        <p>Gesamtgewinn (Verk√§ufe abzgl. Kosten): <strong id="gesamtGewinn">0.00 ‚Ç¨</strong></p>
        <p>Gesch√§tzter **aktueller Lagerwert** (Summe aller offenen Warenwerte): <strong id="lagerwertSumme" class="lagerwert">0.00 ‚Ç¨</strong></p>
        
        <label for="csvFileInput" style="display:inline-block; margin-right: 10px; margin-top: 0;">
            <input type="file" id="csvFileInput" accept=".csv" style="display:none;">
            <button type="button" onclick="document.getElementById('csvFileInput').click()" class="btn-import" style="margin-top: 0;">CSV Importieren</button>
        </label>
        
        <button onclick="exportiereAlsCSV()" class="btn-csv" style="margin-top: 0;">CSV Export (Vollst√§ndig)</button>
        <button onclick="exportiereBestand()" class="btn-bestands" style="margin-top: 0;">CSV Export (Bestand)</button>
        <button onclick="exportiereAlsEUESumme()" class="btn-buchhaltung" style="margin-top: 0;">CSV Export (E√úR Summe)</button>
        <button onclick="exportiereKategorienSumme()" class="btn-kategorie" style="margin-top: 0;">CSV Export (Kategorien Summe)</button>
        <button onclick="alleDatenLoeschen()" class="btn-delete" style="margin-top: 0;">Alle Daten l√∂schen</button>
        
        <div style="margin-top: 20px;">
            <label for="exportStatusFilter" style="display:inline-block; margin-right: 5px; margin-top: 0; font-weight: normal;">Exportiere nach Status (Zeilen):</label>
            <select id="exportStatusFilter" style="width: auto;">
                <option value="alle">Alle Transaktionen</option>
                <option value="im_bestand">Im Bestand</option>
                <option value="reserviert">Reserviert</option>
                <option value="verkauft">Verkauft</option>
                <option value="bezahlt">Bezahlt</option>
            </select>
            <button onclick="exportiereNachStatusFilter()" class="btn-filter-export" style="margin-top: 0;">Export nach Auswahl</button>
        </div>
        
        <div style="margin-top: 10px;">
            <label for="exportKategorieFilter" style="display:inline-block; margin-right: 5px; margin-top: 0; font-weight: normal;">Exportiere nach Kategorie (Zeilen):</label>
            <select id="exportKategorieFilter" style="width: auto;">
                <option value="alle">Alle Kategorien (Vollst√§ndig)</option>
                <option value="Komplettrad">Komplettrad</option>
                <option value="Rahmen">Rahmen</option>
                <option value="Umwerfer">Umwerfer</option>
                <option value="Schaltwerk">Schaltwerk</option>
                <option value="Bremsen">Bremsen</option>
                <option value="Kurbelgarnitur">Kurbelgarnitur</option>
                <option value="Laufradsatz">Laufradsatz</option>
                <option value="Sattel/Sattelst√ºtze">Sattel/Sattelst√ºtze</option>
                <option value="Lenker/Vorbau">Lenker/Vorbau</option>
                <option value="Gruppenset">Gruppenset (Komplett)</option>
                <option value="Sonstiges">Sonstiges</option>
            </select>
            <button onclick="exportiereNachKategorieFilter()" class="btn-bestands" style="margin-top: 0; background-color: #556B2F;">Export nach Kategorie</button>
        </div>
        <table id="einnahmenTabelle">
            <thead>
                <tr>
                    <th onclick="sortiereTabelle(0)">ID ‚Üï</th>
                    <th onclick="sortiereTabelle(1)">Datum ‚Üï</th>
                    <th>Typ</th>
                    <th onclick="sortiereTabelle(3)">Kategorie ‚Üï</th>
                    <th onclick="sortiereTabelle(4)">Artikel ‚Üï</th>
                    <th onclick="sortiereTabelle(5)">Warenwert ‚Üï</th>
                    <th onclick="sortiereTabelle(6)">VK-Preis ‚Üï</th>
                    <th onclick="sortiereTabelle(7)">Kosten ‚Üï</th>
                    <th onclick="sortiereTabelle(8)">Status ‚Üï</th>
                    <th onclick="sortiereTabelle(9)">Netto-Wert ‚Üï</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        const STORAGE_KEY = 'fahrradteileTransaktionen';
        
        // Elemente
        const einnahmeForm = document.getElementById('einnahmeForm');
        const einnahmenTabelleBody = document.querySelector('#einnahmenTabelle tbody');
        const gesamtGewinnElement = document.getElementById('gesamtGewinn');
        const lagerwertSummeElement = document.getElementById('lagerwertSumme');
        const submitButton = document.getElementById('submitButton');
        const cancelButton = document.getElementById('cancelButton');
        const editIndexInput = document.getElementById('editIndex');
        const transaktionsIDInput = document.getElementById('transaktionsID'); // NEU: ID Feld
        const csvFileInput = document.getElementById('csvFileInput');
        const typSelect = document.getElementById('typ');
        const kategorieSelect = document.getElementById('kategorie');
        const datumInput = document.getElementById('datum');
        const warenwertBeiUebernahmeInput = document.getElementById('warenwertBeiUebernahme');
        const einnahmeVerkaufspreisInput = document.getElementById('einnahme_verkaufspreis');
        const kostenInput = document.getElementById('kosten');
        const statusContainer = document.getElementById('status-container');
        const verkaufStatusSelect = document.getElementById('verkaufStatus');
        const exportStatusFilter = document.getElementById('exportStatusFilter');
        const exportKategorieFilter = document.getElementById('exportKategorieFilter');
        
        // Setze das heutige Datum beim Laden
        datumInput.value = new Date().toISOString().split('T')[0];
        typSelect.value = 'einkauf'; 

        // Funktion zur Anzeige/Ausblendung des Status-Feldes
        window.zeigeStatusFeld = function() {
            if (typSelect.value === 'verkauf') {
                statusContainer.style.display = 'block';
                verkaufStatusSelect.value = 'im_bestand'; 
            } else {
                statusContainer.style.display = 'none';
                verkaufStatusSelect.value = 'im_bestand';
            }
        }
        zeigeStatusFeld(); 
        
        // =========================================================================
        // 1. Logik zur Datenverwaltung (ID-Generierung, Migration)
        // =========================================================================

        /** Findet die h√∂chste aktuelle ID im Datensatz und gibt sie zur√ºck. */
        function getNextID(daten) {
            if (daten.length === 0) return 1;
            const maxID = daten.reduce((max, t) => Math.max(max, t.id || 0), 0);
            return maxID + 1;
        }


        function ladeEinnahmen() {
            const jsonString = localStorage.getItem(STORAGE_KEY);
            try {
                const daten = jsonString ? JSON.parse(jsonString) : [];
                
                let aenderungenGemacht = false;
                let idCounter = getNextID(daten); // Starte Z√§hler basierend auf vorhandenen IDs

                // Migration: ID zuweisen, falls fehlt
                daten.forEach(eintrag => {
                    // ID Zuweisung (wenn fehlt)
                    if (!eintrag.id) {
                        // Weisen Sie eine ID basierend auf dem aktuellen Z√§hler zu, 
                        // was im Falle fehlender IDs die h√∂chste ID + 1 w√§re.
                        // F√ºr Konsistenz sollten wir hier besser die aktuelle ID verwenden, 
                        // wenn wir sie nachtr√§glich zuweisen.
                        // Besser: Lassen Sie die ID nur beim Erstellen generieren.
                        // F√ºr alte Daten ohne ID, generieren wir eine tempor√§re ID zur Sortierung, 
                        // aber das Speichern w√ºrde die Reihenfolge st√∂ren.
                        // Wichtig: Beim ersten Start mit diesem Code, falls Daten ohne ID vorhanden sind, 
                        // weisen wir die fortlaufende ID zu.
                        eintrag.id = idCounter++;
                        aenderungenGemacht = true;
                    }
                    
                    // Andere Migrationen (wie gehabt)
                    if (eintrag.einkaufspreis !== undefined) {
                        eintrag.warenwertBeiUebernahme = eintrag.einkaufspreis;
                        delete eintrag.einkaufspreis;
                        aenderungenGemacht = true;
                    }
                    if (eintrag.verkaufStatus === undefined || eintrag.verkaufStatus === 'offen') {
                        eintrag.verkaufStatus = 'im_bestand';
                        aenderungenGemacht = true;
                    }
                    // WICHTIG: Die automatische Migration von Sonstiges->Komplettrad ist hier DEAKTIVIERT, 
                    // um die Kategorie 'Sonstiges' beizubehalten, wie zuletzt gew√ºnscht.
                });

                // Konsistente ID-Werte abspeichern
                if (aenderungenGemacht) {
                    speichereEinnahmen(daten); 
                }
                
                return daten;

            } catch (e) {
                console.error("Fehler beim Parsen der gespeicherten JSON-Daten:", e);
                return [];
            }
        }

        function speichereEinnahmen(einnahmen) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(einnahmen));
        }

        /** Berechnet den Netto-Wert des Eintrags: Gewinn (bei Verkauf) oder Kosten (bei Einkauf) */
        function berechneAktuellenWert(eintrag) {
            return eintrag.einnahmeVerkaufspreis - eintrag.warenwertBeiUebernahme - eintrag.kosten; 
        }

        window.setGroupset = function(name) {
            const artikelFeld = document.getElementById('artikelName');
            artikelFeld.value = name + ' ';
            artikelFeld.focus();
        }
        
        // =========================================================================
        // 2. Transaktions- und Formular-Handling
        // =========================================================================

        einnahmeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const einnahmen = ladeEinnahmen();
            const index = parseInt(editIndexInput.value);
            const isEditing = index > -1;

            const neuerEintrag = {
                // NEU: ID beibehalten bei Bearbeitung, neue ID generieren bei neuer Transaktion
                id: isEditing ? parseInt(transaktionsIDInput.value) : getNextID(einnahmen), 
                datum: datumInput.value,
                typ: typSelect.value,
                kategorie: kategorieSelect.value,
                artikelName: document.getElementById('artikelName').value.trim(),
                warenwertBeiUebernahme: parseFloat(warenwertBeiUebernahmeInput.value) || 0,
                einnahmeVerkaufspreis: parseFloat(einnahmeVerkaufspreisInput.value) || 0,
                kosten: parseFloat(kostenInput.value) || 0,
                verkaufStatus: typSelect.value === 'verkauf' ? verkaufStatusSelect.value : 'im_bestand',
            };
            

            if (isEditing) {
                einnahmen[index] = neuerEintrag;
            } else {
                einnahmen.push(neuerEintrag);
            }

            speichereEinnahmen(einnahmen);
            zeigeEinnahmenAn(einnahmen);
            abbrechenBearbeitung();
        });

        window.starteBearbeitung = function(index) {
            const einnahmen = ladeEinnahmen();
            const eintrag = einnahmen[index];

            transaktionsIDInput.value = eintrag.id; // NEU: ID in Formular laden
            datumInput.value = eintrag.datum || new Date().toISOString().split('T')[0];
            typSelect.value = eintrag.typ;
            kategorieSelect.value = eintrag.kategorie || 'Sonstiges';
            document.getElementById('artikelName').value = eintrag.artikelName;
            warenwertBeiUebernahmeInput.value = eintrag.warenwertBeiUebernahme;
            einnahmeVerkaufspreisInput.value = eintrag.einnahmeVerkaufspreis;
            kostenInput.value = eintrag.kosten;
            
            if (eintrag.typ === 'verkauf') {
                verkaufStatusSelect.value = eintrag.verkaufStatus || 'im_bestand';
                statusContainer.style.display = 'block';
            } else {
                statusContainer.style.display = 'none';
            }
            
            editIndexInput.value = index;
            submitButton.textContent = '√Ñnderungen speichern';
            cancelButton.style.display = 'inline-block';
            document.getElementById('eingabe-formular').scrollIntoView({ behavior: 'smooth' });
        }

        window.loescheEintrag = function(index) {
            if (confirm('Soll dieser Eintrag wirklich gel√∂scht werden?')) {
                const einnahmen = ladeEinnahmen();
                einnahmen.splice(index, 1);
                speichereEinnahmen(einnahmen);
                zeigeEinnahmenAn();
                abbrechenBearbeitung();
            }
        }

        window.abbrechenBearbeitung = function() {
            einnahmeForm.reset();
            datumInput.value = new Date().toISOString().split('T')[0];
            typSelect.value = 'einkauf'; 
            kategorieSelect.value = 'Sonstiges';
            warenwertBeiUebernahmeInput.value = '0.00';
            einnahmeVerkaufspreisInput.value = '0.00';
            kostenInput.value = '0.00';
            editIndexInput.value = -1;
            transaktionsIDInput.value = -1; // NEU: ID zur√ºcksetzen
            submitButton.textContent = 'Transaktion speichern';
            cancelButton.style.display = 'none';
            zeigeStatusFeld();
        }
        
        // =========================================================================
        // 3. Sortierung (JETZT F√úR MEHRERE SPALTEN!)
        // =========================================================================
        
        let sortColumnIndex = 0; // Default: Sortiere nach ID
        let sortDirection = 1; // 1 = aufsteigend, -1 = absteigend

        const sortierSpalten = {
            0: (a, b) => (a.id || 0) - (b.id || 0), // ID (Numerisch)
            1: (a, b) => a.datum.localeCompare(b.datum), // Datum (String)
            3: (a, b) => (a.kategorie || 'Sonstiges').localeCompare(b.kategorie || 'Sonstiges', 'de', { sensitivity: 'base' }), // Kategorie (Alphabetisch)
            4: (a, b) => a.artikelName.localeCompare(b.artikelName, 'de', { sensitivity: 'base' }), // Artikel (Alphabetisch)
            5: (a, b) => a.warenwertBeiUebernahme - b.warenwertBeiUebernahme, // Warenwert (Numerisch)
            6: (a, b) => a.einnahmeVerkaufspreis - b.einnahmeVerkaufspreis, // VK-Preis (Numerisch)
            7: (a, b) => a.kosten - b.kosten, // Kosten (Numerisch)
            8: (a, b) => (a.verkaufStatus || 'im_bestand').localeCompare(b.verkaufStatus || 'im_bestand', 'de', { sensitivity: 'base' }), // Status (Alphabetisch)
            9: (a, b) => berechneAktuellenWert(a) - berechneAktuellenWert(b) // Netto-Wert (Numerisch)
        };

        window.sortiereTabelle = function(columnIndex) {
            let transaktionen = ladeEinnahmen();
            
            // √úberpr√ºfe, ob die Spalte sortierbar ist
            if (!sortierSpalten[columnIndex]) return; 

            // Sortierrichtung setzen
            if (sortColumnIndex === columnIndex) {
                sortDirection = -sortDirection;
            } else {
                sortDirection = 1;
                sortColumnIndex = columnIndex;
            }

            // Sortierung anwenden
            transaktionen.sort((a, b) => {
                const sortFunc = sortierSpalten[columnIndex];
                const comparison = sortFunc(a, b);
                return comparison * sortDirection;
            });

            // WICHTIG: Die Sortierung wird im Speicher gespeichert, damit sie erhalten bleibt
            speichereEinnahmen(transaktionen); 
            zeigeEinnahmenAn(transaktionen); 
        }


        // =========================================================================
        // 4. Anzeige und Berechnung der Kennzahlen
        // =========================================================================
        
        function zeigeEinnahmenAn() {
            const transaktionen = ladeEinnahmen();
            einnahmenTabelleBody.innerHTML = '';
            
            let gesamtGewinn = 0;
            let aktuellerLagerwert = 0;
            
            // Header-Update: Pfeile f√ºr Sortierrichtung
            document.querySelectorAll('#einnahmenTabelle th').forEach((th, index) => {
                if (sortierSpalten[index]) {
                    let text = th.textContent.replace(' ‚ñ≤', '').replace(' ‚ñº', '').replace(' ‚Üï', '');
                    if (index === sortColumnIndex) {
                        text += sortDirection === 1 ? ' ‚ñ≤' : ' ‚ñº';
                    } else {
                        text += ' ‚Üï';
                    }
                    th.textContent = text;
                }
            });


            transaktionen.forEach((eintrag, index) => {
                const aktuellerWert = berechneAktuellenWert(eintrag);
                
                gesamtGewinn += aktuellerWert;
                
                // Lagerwert: Artikel, die NICHT bezahlt sind
                if (eintrag.verkaufStatus !== 'bezahlt') {
                     aktuellerLagerwert += (eintrag.warenwertBeiUebernahme + eintrag.kosten);
                }

                const row = einnahmenTabelleBody.insertRow();
                row.insertCell(0).textContent = eintrag.id; // NEU: ID
                row.insertCell(1).textContent = eintrag.datum;
                row.insertCell(2).textContent = eintrag.typ.toUpperCase();
                row.insertCell(3).textContent = eintrag.kategorie || 'Sonstiges';
                row.insertCell(4).textContent = eintrag.artikelName;
                row.insertCell(5).textContent = eintrag.warenwertBeiUebernahme.toFixed(2) + ' ‚Ç¨';
                row.insertCell(6).textContent = eintrag.einnahmeVerkaufspreis.toFixed(2) + ' ‚Ç¨'; 
                row.insertCell(7).textContent = eintrag.kosten.toFixed(2) + ' ‚Ç¨';
                
                // Status-Zelle (Index 8)
                const statusZelle = row.insertCell(8);
                statusZelle.textContent = (eintrag.verkaufStatus || 'im_bestand').toUpperCase().replace('_', ' ');
                statusZelle.classList.add('status-' + (eintrag.verkaufStatus || 'im_bestand').toLowerCase().replace(/ /g, ''));


                const aktuellerWertZelle = row.insertCell(9);
                aktuellerWertZelle.textContent = aktuellerWert.toFixed(2) + ' ‚Ç¨';
                aktuellerWertZelle.classList.add(aktuellerWert >= 0 ? 'gewinn-positiv' : 'gewinn-negativ');

                const aktionenZelle = row.insertCell(10); // Index 10
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Bearbeiten';
                editBtn.classList.add('btn-edit', 'btn-small');
                editBtn.onclick = () => starteBearbeitung(index);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'L√∂schen';
                deleteBtn.classList.add('btn-delete', 'btn-small');
                deleteBtn.onclick = () => loescheEintrag(index);
                
                aktionenZelle.appendChild(editBtn);
                aktionenZelle.appendChild(deleteBtn);
            });

            gesamtGewinnElement.textContent = gesamtGewinn.toFixed(2) + ' ‚Ç¨';
            lagerwertSummeElement.textContent = aktuellerLagerwert.toFixed(2) + ' ‚Ç¨';
        }

        // =========================================================================
        // 5. Export-Funktionen 
        // =========================================================================

        /** Hilfsfunktion zum Ausl√∂sen des Downloads */
        function starteDownload(csvContent, filename) {
            const blob = new Blob(["\uFEFF", csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.click();
        }

        // NEU: ID in den Header aufgenommen
        const HEADER_FIELDS = ["ID", "Datum", "Typ", "Kategorie", "Artikelname", "Warenwert (‚Ç¨)", "VK-Preis (‚Ç¨)", "Kosten (‚Ç¨)", "Status", "Netto-Wert (‚Ç¨)"];

        function erstelleCSV(transaktionen) {
            let csvContent = HEADER_FIELDS.join(';') + "\n";
            
            transaktionen.forEach(eintrag => {
                const nettoWert = berechneAktuellenWert(eintrag);
                const row = [
                    eintrag.id || '', // ID
                    eintrag.datum,
                    eintrag.typ,
                    eintrag.kategorie || 'Sonstiges',
                    `"${eintrag.artikelName.replace(/"/g, '""')}"`,
                    eintrag.warenwertBeiUebernahme.toFixed(2).replace('.', ','),
                    eintrag.einnahmeVerkaufspreis.toFixed(2).replace('.', ','),
                    eintrag.kosten.toFixed(2).replace('.', ','),
                    eintrag.verkaufStatus || 'im_bestand', 
                    nettoWert.toFixed(2).replace('.', ',')
                ];
                csvContent += row.join(';') + "\n";
            });
            return csvContent;
        }

        // Export Funktionen (unver√§ndert in der Logik)
        window.exportiereAlsCSV = function() {
            const transaktionen = ladeEinnahmen();
            if (transaktionen.length === 0) {
                alert('Keine Daten zum Exportieren vorhanden.');
                return;
            }
            const csvContent = erstelleCSV(transaktionen);
            const filename = 'fahrradteile_transaktionen_vollstaendig_' + new Date().toISOString().split('T')[0] + '.csv';
            starteDownload(csvContent, filename);
        }
        
        window.exportiereBestand = function() {
            const transaktionen = ladeEinnahmen();
            if (transaktionen.length === 0) {
                alert('Keine Daten zum Exportieren vorhanden.');
                return;
            }
            const bestandsTransaktionen = transaktionen.filter(t => t.verkaufStatus !== 'bezahlt');
            const csvContent = erstelleCSV(bestandsTransaktionen);
            const filename = 'fahrradteile_bestand_offen_' + new Date().toISOString().split('T')[0] + '.csv';
            starteDownload(csvContent, filename);
        }

        window.exportiereNachStatusFilter = function() {
            const statusFilter = exportStatusFilter.value;
            const transaktionen = ladeEinnahmen();
            if (transaktionen.length === 0) { alert('Keine Daten zum Exportieren vorhanden.'); return; }
            let gefilterteTransaktionen = statusFilter !== 'alle' ? transaktionen.filter(t => t.verkaufStatus === statusFilter) : transaktionen;
            if (gefilterteTransaktionen.length === 0) { alert(`Keine Transaktionen mit Status "${statusFilter.toUpperCase().replace('_', ' ')}" gefunden.`); return; }
            const csvContent = erstelleCSV(gefilterteTransaktionen);
            const filename = `fahrradteile_export_status_${statusFilter}_` + new Date().toISOString().split('T')[0] + '.csv';
            starteDownload(csvContent, filename);
        }
        
        window.exportiereNachKategorieFilter = function() {
            const kategorieFilter = document.getElementById('exportKategorieFilter').value;
            const transaktionen = ladeEinnahmen();
            if (transaktionen.length === 0) { alert('Keine Daten zum Exportieren vorhanden.'); return; }
            let gefilterteTransaktionen = kategorieFilter !== 'alle' ? transaktionen.filter(t => (t.kategorie || 'Sonstiges') === kategorieFilter) : transaktionen;
            if (gefilterteTransaktionen.length === 0) { alert(`Keine Transaktionen in der Kategorie "${kategorieFilter}" gefunden.`); return; }
            const csvContent = erstelleCSV(gefilterteTransaktionen);
            const filename = `fahrradteile_export_kategorie_${kategorieFilter}_` + new Date().toISOString().split('T')[0] + '.csv';
            starteDownload(csvContent, filename);
        }

        window.exportiereAlsEUESumme = function() {
            const transaktionen = ladeEinnahmen();
            if (transaktionen.length === 0) { alert('Keine Daten zum Exportieren vorhanden.'); return; }
            let summeEinnahmen = 0;
            let summeWarenEK = 0;
            let summeLaufendeKosten = 0;
            transaktionen.forEach(eintrag => {
                if (eintrag.verkaufStatus === 'bezahlt') {
                    summeEinnahmen += eintrag.einnahmeVerkaufspreis;
                    summeWarenEK += eintrag.warenwertBeiUebernahme;
                    summeLaufendeKosten += eintrag.kosten;
                }
            });
            const nettoUeberschuss = summeEinnahmen - summeWarenEK - summeLaufendeKosten;
            const header = ["E√úR Position", "Betrag (‚Ç¨)"];
            let csvContent = header.join(';') + "\n";
            const datum = new Date().toISOString().split('T')[0];
            csvContent += "Stand am " + datum + " (Nur bezahlte Transaktionen);\n";
            csvContent += "Summe Betriebseinnahmen (VK Erl√∂se);"+ summeEinnahmen.toFixed(2).replace('.', ',') + "\n";
            csvContent += "Summe Wareneinkauf (Warenwerte bei √úbernahme);"+ summeWarenEK.toFixed(2).replace('.', ',') + "\n";
            csvContent += "Summe Laufende Kosten (Porto/Geb√ºhren);"+ summeLaufendeKosten.toFixed(2).replace('.', ',') + "\n";
            csvContent += "Netto-√úberschuss (Einnahmen abzgl. Ausgaben);"+ nettoUeberschuss.toFixed(2).replace('.', ',') + "\n";
            const filename = 'fahrradteile_euer_summe_' + datum + '.csv';
            starteDownload(csvContent, filename);
        }

        window.exportiereKategorienSumme = function() {
            const transaktionen = ladeEinnahmen();
            if (transaktionen.length === 0) { alert('Keine Daten zum Exportieren vorhanden.'); return; }
            const kategorienSumme = {};
            transaktionen.forEach(eintrag => {
                const kategorie = eintrag.kategorie || 'Sonstiges';
                const nettoWert = berechneAktuellenWert(eintrag);
                if (!kategorienSumme[kategorie]) { kategorienSumme[kategorie] = { einnahmen: 0, warenwert: 0, kosten: 0, netto: 0 }; }
                kategorienSumme[kategorie].einnahmen += eintrag.einnahmeVerkaufspreis;
                kategorienSumme[kategorie].warenwert += eintrag.warenwertBeiUebernahme;
                kategorienSumme[kategorie].kosten += eintrag.kosten;
                kategorienSumme[kategorie].netto += nettoWert;
            });
            const header = ["Kategorie", "Summe VK Erl√∂se (‚Ç¨)", "Summe Warenwert (‚Ç¨)", "Summe Kosten (‚Ç¨)", "Netto Ergebnis (‚Ç¨)"];
            let csvContent = header.join(';') + "\n";
            const datum = new Date().toISOString().split('T')[0];
            csvContent += "Stand am " + datum + ";;;;\n";
            const sortierteKategorien = Object.keys(kategorienSumme).sort();
            let gesamtEinnahmen = 0;
            let gesamtWarenwert = 0;
            let gesamtKosten = 0;
            let gesamtNetto = 0;
            sortierteKategorien.forEach(kategorie => {
                const summen = kategorienSumme[kategorie];
                gesamtEinnahmen += summen.einnahmen;
                gesamtWarenwert += summen.warenwert;
                gesamtKosten += summen.kosten;
                gesamtNetto += summen.netto;
                const row = [ kategorie, summen.einnahmen.toFixed(2).replace('.', ','), summen.warenwert.toFixed(2).replace('.', ','), summen.kosten.toFixed(2).replace('.', ','), summen.netto.toFixed(2).replace('.', ',') ];
                csvContent += row.join(';') + "\n";
            });
            csvContent += ";;;;\n"; 
            csvContent += "GESAMTSUMME (ALLE KATEGORIEN);" 
                + gesamtEinnahmen.toFixed(2).replace('.', ',') + ";"
                + gesamtWarenwert.toFixed(2).replace('.', ',') + ";"
                + gesamtKosten.toFixed(2).replace('.', ',') + ";"
                + gesamtNetto.toFixed(2).replace('.', ',') + "\n";
            const filename = 'fahrradteile_kategorien_summe_' + datum + '.csv';
            starteDownload(csvContent, filename);
        }


        // =========================================================================
        // 6. CSV-Import (Anpassung an 9 Datenfelder + 1 ID-Feld)
        // =========================================================================

        csvFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                verarbeiteImportierteCSV(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        });

        /** Verarbeitet die CSV-Daten (erwartet 9 Datenfelder + ID). */
        function verarbeiteImportierteCSV(csvText) {
            // Ignoriere Header-Zeilen
            const lines = csvText.split('\n').filter(line => line.trim() !== '' && !line.startsWith("ID") && !line.startsWith("Stand") && !line.startsWith("E√úR Position") && !line.startsWith("Kategorie")); 
            
            if (lines.length === 0) {
                alert('CSV-Datei enth√§lt keine Datenzeilen oder die Daten sind nicht im erwarteten Format.');
                return;
            }

            const aktuelleEinnahmen = ladeEinnahmen();
            const neueEinnahmen = [];
            let fehlerZaehler = 0;
            let nextID = getNextID(aktuelleEinnahmen);

            lines.forEach(line => {
                const values = line.split(';');

                // Wir erwarten jetzt 10 Felder, aber der Netto-Wert (Feld 9) wird ignoriert, da er berechnet wird.
                if (values.length >= 9) { 
                    try {
                        // NEU: ID aus CSV lesen (Feld 0) oder neue ID zuweisen
                        const id = parseInt(values[0].replace(/[^0-9]/g, '')) || nextID++;
                        const datum = values[1].trim();
                        const typ = values[2].toLowerCase().trim();
                        const kategorie = values[3].trim(); 
                        const artikelName = values[4].replace(/"/g, '').trim(); 
                        
                        // Ab hier sind die Feld-Indizes um 1 nach hinten verschoben
                        const warenwertBeiUebernahme = parseFloat(values[5].replace(',', '.'));
                        const einnahmeVerkaufspreis = parseFloat(values[6].replace(',', '.'));
                        const kosten = parseFloat(values[7].replace(',', '.'));
                        const verkaufStatus = values[8].toLowerCase().trim().replace(' ', '_'); 

                        if (!isNaN(warenwertBeiUebernahme) && !isNaN(einnahmeVerkaufspreis) && !isNaN(kosten) && (typ === 'verkauf' || typ === 'einkauf')) {
                            neueEinnahmen.push({
                                id: id,
                                datum: datum,
                                typ: typ,
                                kategorie: kategorie,
                                artikelName: artikelName,
                                warenwertBeiUebernahme: warenwertBeiUebernahme,
                                einnahmeVerkaufspreis: einnahmeVerkaufspreis,
                                kosten: kosten,
                                verkaufStatus: verkaufStatus,
                            });
                            // Stelle sicher, dass die neue ID (falls verwendet) den Z√§hler erh√∂ht
                            if (id === nextID - 1) nextID = id + 1;
                        } else {
                            fehlerZaehler++;
                        }
                    } catch (e) {
                        fehlerZaehler++;
                    }
                } else {
                    fehlerZaehler++;
                }
            });

            if (neueEinnahmen.length > 0) {
                const bestaetigung = confirm(`Sollen ${neueEinnahmen.length} g√ºltige Eintr√§ge zu den existierenden ${aktuelleEinnahmen.length} Eintr√§gen hinzugef√ºgt werden?`);

                if (bestaetigung) {
                    const kombinierteEinnahmen = aktuelleEinnahmen.concat(neueEinnahmen);
                    speichereEinnahmen(kombinierteEinnahmen);
                    zeigeEinnahmenAn();
                    alert(`Import erfolgreich. ${neueEinnahmen.length} Eintr√§ge hinzugef√ºgt. (Fehlerhafte/Ignorierte Zeilen: ${fehlerZaehler})`);
                }
            } else {
                 alert('Keine g√ºltigen Eintr√§ge in der CSV-Datei gefunden.');
            }
        }
        
        window.alleDatenLoeschen = function() {
            if (confirm('Sollen wirklich ALLE gespeicherten Transaktionen gel√∂scht werden?')) {
                localStorage.removeItem(STORAGE_KEY);
                zeigeEinnahmenAn();
                alert('Alle Daten wurden gel√∂scht.');
            }
        }

        zeigeEinnahmenAn();
    </script>

</body>
</html>